<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sudoku</title>
  <link rel="stylesheet" href="./assets/css/style.css" />
  <link rel="shortcut icon" href="./assets/icons/logo.png" type="image/x-icon">
</head>

<body>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splash">
    <div class="splash-logo"></div>
    <div class="splash-text">Sudoku</div>
  </div>

  <!-- Home Screen -->
  <div class="home-container" id="homeScreen">
    <h1 class="home-title">SUDOKU</h1>
    <div class="menu-container">
      <button class="home-btn" id="startBtn" tabindex="0">Start</button>
      <button class="home-btn" id="howBtn" tabindex="0">How to Play</button>
      <button class="home-btn" id="aboutBtn" tabindex="0">About</button>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" style="display: none;">
    <div class="topbar">
      <span>Mistakes: <span id="mistakeCount">0</span>/5 </span>
      <span>Level: <span id="difficultyDisplay">Medium</span> </span>
    </div>
    <div class="container">
    </div>
    <div class="double-exit-msg" id="exit-msg">Click twice to go home</div>
    <div id="toast"></div>

    <div id="controls">
      <button type="button" class="btn primary soft-left" data-action="solve">Solve</button>
      <button type="button" class="btn primary soft-right" data-action="home">Home</button>
    </div>
  </div>

  <!-- How to Play Popup -->
  <div class="popup-container" id="howPopup">
    <div class="popup-content">
      <h3>Game Rules</h3>
      <p>Fill each 9×9 grid so that every row, column, and 3×3 box contains digits 1–9 without repetition.</p>
      <p>Use logic and deduction — no guessing required!</p>
      <button class="btn ok-btn">OK</button>
    </div>
  </div>

  <!-- About Popup -->
  <div class="popup-container" id="aboutPopup">
    <div class="popup-content">
      <h3>About Sudoku</h3>
      <p>Sudoku is a logic-based puzzle game that enhances focus and reasoning.</p>
      <button class="btn ok-btn">OK</button>
    </div>
  </div>

  <!-- Watch Video Confirmation Popup -->
  <div class="popup-container" id="videoConfirmPopup">
    <div class="popup-content">
      <h3>Watch Video?</h3>
      <p>Do you want to watch a video to unlock the solution?</p>
      <div class="popup-buttons">
        <button class="btn yes-btn" id="yesWatchBtn" tabindex="0">Yes</button>
        <button class="btn no-btn" id="noWatchBtn" tabindex="0">No</button>
      </div>
    </div>
  </div>

  <script src="./assets/js/app.js" type="text/javascript"></script>
  <script src="./assets/js/jiogames_jp.js"></script>

  <script>
    // Global state management
    let isGameActive = false;
    let isPopUpOpen = false;
    let currentPopup = null;
    let isVideoConfirmOpen = false;
    let videoPopupSelectedIndex = 0;

    document.addEventListener("DOMContentLoaded", () => {
      const splash = document.getElementById("splash");
      const homeScreen = document.getElementById("homeScreen");
      const gameScreen = document.getElementById("gameScreen");
      const buttons = Array.from(document.querySelectorAll(".menu-container .home-btn"));
      const videoConfirmPopup = document.getElementById("videoConfirmPopup");
      const yesBtn = document.getElementById("yesWatchBtn");
      const noBtn = document.getElementById("noWatchBtn");
      const videoButtons = [yesBtn, noBtn];
      let index = 0;

      // Hide splash after 2s, then focus first button
      window.addEventListener("load", () => {
        setTimeout(() => {
          splash.classList.add("hide");
          setTimeout(() => { 
            buttons[index].focus(); 
            splash.style.display = "none";
          }, 100);
        }, 2000);
      });

      // Function to show video confirmation popup
      function showVideoConfirmPopup() {
        videoConfirmPopup.classList.add("active");
        isVideoConfirmOpen = true;
        videoPopupSelectedIndex = 0;
        videoButtons[videoPopupSelectedIndex].focus();
      }

      // Function to close video confirmation popup
      function closeVideoConfirmPopup() {
        videoConfirmPopup.classList.remove("active");
        isVideoConfirmOpen = false;
        const firstEditable = document.querySelector(".sudoku-container input:not(.disabled)");
        if (firstEditable) {
          firstEditable.focus();
        } else {
          // retry once more if DOM not ready
          setTimeout(() => {
            const retry = document.querySelector(".sudoku-container input:not(.disabled)");
            if (retry) retry.focus();
          }, 400);
        }
      }

      // Function to show game screen
      function showGameScreen() {
        homeScreen.style.display = "none";
        gameScreen.style.display = "block";
        isGameActive = true;
        game.reset();
        game.start();
        if (typeof gameCacheAd === 'function') {
          gameCacheAd();
        }
      }

      // Function to show home screen
      function showHomeScreen() {
        gameScreen.style.display = "none";
        homeScreen.style.display = "block";
        isGameActive = false;
        buttons[index].focus();
      }

      // Home screen key navigation
      document.addEventListener("keyup", (e) => {
        const key = e.key;

        // If video confirm popup is open, handle its navigation
        if (isVideoConfirmOpen) {
          if (key === "ArrowLeft") {
            videoPopupSelectedIndex = 0;
            videoButtons[videoPopupSelectedIndex].focus();
          } else if (key === "ArrowRight") {
            videoPopupSelectedIndex = 1;
            videoButtons[videoPopupSelectedIndex].focus();
          } else if (key === "Enter" || key === "OK") {
            if (videoPopupSelectedIndex === 0) {
              closeVideoConfirmPopup();
              if (typeof isRVReady !== 'undefined' && isRVReady) {
                if (typeof showAdRewarded === 'function') {
                  showAdRewarded();
                }
              } else {
                if (typeof showToast === 'function') {
                  showToast("Please click after some time.");
                }
                console.log("Rewarded video ad not ready, click after sometime");
              }
            } else {
              // No - Close popup
              closeVideoConfirmPopup();
            }
          } else if (key === "Backspace") {
            // Cancel and close popup
            closeVideoConfirmPopup();
          }
          return;
        }

        // If game is active, let game controls handle it
        if (isGameActive) {
          return;
        }

        if (isPopUpOpen) {
          if (key === "Enter" || key === "OK") {
            // Close popup
            currentPopup.classList.remove("active");
            isPopUpOpen = false;
            currentPopup = null;
            buttons[index].focus();
          }
          return;
        }

        if (key === "ArrowUp") {
          index = (index - 1 + buttons.length) % buttons.length;
          buttons[index].focus();
        } else if (key === "ArrowDown") {
          index = (index + 1) % buttons.length;
          buttons[index].focus();
        } else if (key === "Enter" || key === "OK") {
          const id = buttons[index].id;
          if (id === "startBtn") {
            showGameScreen();
          } else if (id === "howBtn") {
            currentPopup = document.getElementById("howPopup");
            currentPopup.classList.add("active");
            isPopUpOpen = true;
            currentPopup.querySelector(".ok-btn").focus();
          } else if (id === "aboutBtn") {
            currentPopup = document.getElementById("aboutPopup");
            currentPopup.classList.add("active");
            isPopUpOpen = true;
            currentPopup.querySelector(".ok-btn").focus();
          }
        }
      });

      // Expose function for game controls to return home
      window.returnToHome = showHomeScreen;
    });
  </script>

  <!-- Feature phone (Jio Bharat) controls -->
  <script>
    (function () {
      let lastBackspaceTime = 0;
      const DOUBLE_PRESS_DELAY = 500; // ms

      document.addEventListener("keydown", function (e) {
        const key = e.key;
        const active = document.activeElement;

        // Handle Backspace on home screen - allow default behavior (close app)
        if (!isGameActive && key === "Backspace") {
          window.close();
          return;
        }

        // Only handle game controls when game is active
        if (!isGameActive) return;

        switch (key) {

          // Enter → Validate Sudoku
          case "Enter":
            break;

          // SoftLeft → Show video confirmation popup
          case "SoftLeft":
            const videoConfirmPopup = document.getElementById("videoConfirmPopup");
            videoConfirmPopup.classList.add("active");
            isVideoConfirmOpen = true;
            videoPopupSelectedIndex = 0;
            document.getElementById("yesWatchBtn").focus();
            break;

          // SoftRight → Home
          case "SoftRight":
            if (typeof isAdReady !== 'undefined' && isAdReady) {
              showAd();
            } else {
              console.log("Mid roll ad not ready");
            }
            if (typeof window.returnToHome === 'function') {
              window.returnToHome();
            }
            break;

          // Backspace on game screen - double press to go home
          case "Backspace":
            e.preventDefault(); // Prevent default on game screen
            const now = Date.now();
            if (now - lastBackspaceTime < DOUBLE_PRESS_DELAY) {
              // Double press → go to home screen
              if (typeof showToast === 'function') {
                showToast("Returning to home...", 1200, "#68DD24E6");
              }
              if (typeof window.returnToHome === 'function') {
                window.returnToHome();
              }
              lastBackspaceTime = 0;
            } else {
              // Single press → clear cell
              if (active && !active.classList.contains("disabled")) {
                active.value = "";
                
                // KaiOS-compatible event creation
                var inputEvent = document.createEvent('HTMLEvents');
                inputEvent.initEvent('input', true, false);
                active.dispatchEvent(inputEvent);
              }
              lastBackspaceTime = now;
              const msg = document.getElementById("exit-msg");
              if (msg) {
                msg.textContent = "Click twice to go home";
                msg.style.display = "block";
                setTimeout(() => {
                  msg.style.display = "none";
                }, 1000);
              }
            }
            break;

          // Number input
          default:
            if (/^[1-9]$/.test(key) && active && !active.classList.contains("disabled")) {
              e.preventDefault();
              active.value = key;
              
              // KaiOS-compatible event creation
              var inputEvent = document.createEvent('HTMLEvents');
              inputEvent.initEvent('input', true, false);
              active.dispatchEvent(inputEvent);
            }
            break;
        }
      });
    })();
  </script>

</body>

</html>